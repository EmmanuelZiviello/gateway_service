# Direttiva events dovrebbe essere all'inizio del file
events {
    worker_connections 1024;
}

http {
    # Mappa metodo + URI in backend corrispondente, considerando i prefissi
    map "$request_method:$uri" $backend {
        default "";  # Se non corrisponde, backend vuoto (evita errori)

        # COMMON (senza prefisso)
        "GET:/refresh"            "https://common-service-n54r.onrender.com";
        "POST:/logout"            "https://common-service-n54r.onrender.com";
        "GET:/status"             "https://common-service-n54r.onrender.com";

        # ADMIN (prefisso /admin/)
        "DELETE:/admin/nutrizionista"   "https://admin-service-8ck3.onrender.com";
        "POST:/admin/nutrizionista"     "https://autenticazione-service-za2f.onrender.com";
        "GET:/admin/nutrizionisti"      "https://admin-service-8ck3.onrender.com";
        "GET:/admin/pazienti"           "https://admin-service-8ck3.onrender.com";
        "DELETE:/admin/paziente"        "https://admin-service-8ck3.onrender.com";
        "POST:/admin/login"             "https://autenticazione-service-za2f.onrender.com";
        "POST:/admin/informativa_privacy" "https://informativa-service.onrender.com";
        "POST:/admin/faq"               "https://common-service-n54r.onrender.com";
        

        # NUTRIZIONISTA (prefisso /nutrizionista/)
        "POST:/nutrizionista/paziente"  "https://autenticazione-service-za2f.onrender.com";
        "GET:/nutrizionista/paziente"  "https://nutrizionista-service.onrender.com";
        "PUT:/nutrizionista/paziente"  "https://nutrizionista-service.onrender.com";
        "GET:/nutrizionista/pazienti"  "https://nutrizionista-service.onrender.com";
        "POST:/nutrizionista/pazienti" "https://nutrizionista-service.onrender.com";
        "DELETE:/nutrizionista/pazienti" "https://nutrizionista-service.onrender.com";
        "GET:/nutrizionista/misurazione_medico" "https://misurazioni-service.onrender.com";
        "POST:/nutrizionista/misurazione_medico" "https://misurazioni-service.onrender.com";
        "PUT:/nutrizionista/misurazione_medico" "https://misurazioni-service.onrender.com";
        "DELETE:/nutrizionista/misurazione_medico" "https://misurazioni-service.onrender.com";
        "GET:/nutrizionista/misurazioni_medico"  "https://misurazioni-service.onrender.com";
        "GET:/nutrizionista/misurazioni_paziente" "https://misurazioni-service.onrender.com";
        "POST:/nutrizionista/disease"    "https://disease-service.onrender.com";
        "DELETE:/nutrizionista/disease"  "https://disease-service.onrender.com";
        "GET:/nutrizionista/get_all_disease" "https://disease-service.onrender.com";
        "GET:/nutrizionista/disease_del_paziente" "https://disease-service.onrender.com";
        "GET:/nutrizionista/dieta"       "https://dieta-service.onrender.com";
        "POST:/nutrizionista/dieta"      "https://dieta-service.onrender.com";
        "PUT:/nutrizionista/dieta"       "https://dieta-service.onrender.com";
        "DELETE:/nutrizionista/dieta"    "https://dieta-service.onrender.com";
        "GET:/nutrizionista/alimenti"    "https://dieta-service.onrender.com";
        "POST:/nutrizionista/predizione" "https://rete-service.onrender.com";
        "GET:/nutrizionista/informativa_privacy" "https://informativa-service.onrender.com";
        "POST:/nutrizionista/informativa_privacy" "https://informativa-service.onrender.com";
        "GET:/nutrizionista/faq"         "https://common-service-n54r.onrender.com";
        "POST:/nutrizionista/login"             "https://autenticazione-service-za2f.onrender.com";

        # PAZIENTE (prefisso /paziente/)
        "POST:/paziente"       "https://autenticazione-service-za2f.onrender.com";
        "PUT:/paziente"        "https://paziente-service-6ld5.onrender.com";
        "GET:/paziente"        "https://paziente-service-6ld5.onrender.com";
        "DELETE:/paziente"     "https://paziente-service-6ld5.onrender.com";
        "GET:/paziente/misurazione_medico" "https://misurazioni-service.onrender.com";
        "POST:/paziente/misurazione"    "https://misurazioni-service.onrender.com";
        "DELETE:/paziente/misurazione"  "https://misurazioni-service.onrender.com";
        "PUT:/paziente/misurazione"     "https://misurazioni-service.onrender.com";
        "GET:/paziente/misurazioni"     "https://misurazioni-service.onrender.com";
        "GET:/paziente/dieta"           "https://dieta-service.onrender.com";
        "GET:/paziente/consensi_utente" "https://consensi-service.onrender.com";
        "PUT:/paziente/consensi_utente" "https://consensi-service.onrender.com";
        "GET:/paziente/richiesta_aggiunta_paziente" "https://richieste-service.onrender.com";
        "PUT:/paziente/richiesta_aggiunta_paziente" "https://richieste-service.onrender.com";
        "DELETE:/paziente/richiesta_aggiunta_paziente" "https://richieste-service.onrender.com";
        "GET:/paziente/nutrizionista"   "https://paziente-service-6ld5.onrender.com";
        "GET:/paziente/informativa_privacy" "https://informativa-service.onrender.com";
        "POST:/paziente/password"       "https://autenticazione-service-za2f.onrender.com";
        "PUT:/paziente/password"        "https://autenticazione-service-za2f.onrender.com";
        "PATCH:/paziente/password"      "https://autenticazione-service-za2f.onrender.com";
        "GET:/paziente/faq"                "https://common-service-n54r.onrender.com";
        "POST:/paziente/login"             "https://autenticazione-service-za2f.onrender.com";
    }

    server {
        listen 80 default_server;

        # Gestione dinamica degli endpoint basata sulla map
        location / {
            if ($backend = "") {
                return 405;  # Metodo HTTP non supportato
            }

            proxy_pass $backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_redirect off;
        }

       
}



